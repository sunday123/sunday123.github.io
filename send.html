<!DOCTYPE html>
<html>
<head>
    <title>文件传输</title>
</head>
<body>
    <!-- 发送方 -->
    <h2>发送方</h2>
    <input type="file" id="fileInput">
    <button onclick="sendFile()">发送</button>
    <br><br>
    
    <!-- 接收方 -->
    <h2>接收方</h2>
    <input type="text" id="verificationCode" placeholder="请输入接收码">
    <button onclick="receiveFile()">接收</button>
    
    <script src="https://cdn.jsdelivr.net/npm/simple-peer/simplepeer.min.js"></script>
    <script>
        var senderPeer;
        var receiverPeer;
        
        function sendFile() {
            var fileInput = document.getElementById('fileInput');
            var file = fileInput.files[0];
            
            if (!file) {
                alert('请选择文件');
                return;
            }
            
            var verificationCode = generateVerificationCode();
            var fileReader = new FileReader();
            var chunkSize = 16384; // 每次发送的数据块大小
            
            fileReader.onload = function(event) {
                var fileData = event.target.result;
                var offset = 0;
                
                sendChunk(); // 开始发送第一个数据块
                
                function sendChunk() {
                    var chunk = fileData.slice(offset, offset + chunkSize);
                    
                    if (chunk.byteLength > 0) {
                        // 发送数据块给接收方
                        senderPeer.send(chunk);
                        
                        offset += chunk.byteLength;
                        setTimeout(sendChunk, 0); // 继续发送下一个数据块
                    } else {
                        var data = {
                            fileName: file.name,
                            verificationCode: verificationCode
                        };
                        
                        // 发送文件结束标志和文件信息给接收方
                        senderPeer.send(JSON.stringify(data));
                        
                        alert('文件已发送，接收码为：' + verificationCode);
                    }
                }
            };
            
            fileReader.readAsArrayBuffer(file);
        }
        
        function receiveFile() {
            var verificationCodeInput = document.getElementById('verificationCode');
            var verificationCode = verificationCodeInput.value;
            
            if (!verificationCode) {
                alert('请输入接收码');
                return;
            }
            
            var receivedData = {
                fileName: '',
                fileData: []
            };
            
            receiverPeer.on('data', function(data) {
                if (typeof data === 'string') {
                    var fileInfo = JSON.parse(data);
                    
                    if (fileInfo.verificationCode === verificationCode) {
                        receivedData.fileName = fileInfo.fileName;
                    } else {
                        alert('接收码错误');
                    }
                } else if (data instanceof ArrayBuffer) {
                    receivedData.fileData.push(data);
                }
            });
            
            receiverPeer.on('close', function() {
                if (receivedData.fileName && receivedData.fileData.length > 0) {
                    var fileData = new Blob(receivedData.fileData);
                    var fileName = receivedData.fileName;
                    
                    var downloadLink = document.createElement('a');
                    downloadLink.href = URL.createObjectURL(fileData);
                    downloadLink.download = fileName;
                    downloadLink.click();
                    
                    alert('文件已接收');
                } else {
                    alert('接收文件失败');
                }
            });
            
            // 创建接收方的Peer对象并连接到发送方
            receiverPeer = new SimplePeer({ initiator: false });
            
            receiverPeer.on('signal', function(answer) {
                senderPeer.signal(answer);
            });
        }
        
        function generateVerificationCode() {
            // 生成随机的2位数验证码
            return Math.floor(Math.random() * 90 + 10).toString();
        }
        
        // 创建发送方的Peer对象
        senderPeer = new SimplePeer({ initiator: true });
        
        // 发送方连接到接收方
        senderPeer.on('signal', function(offer) {
            receiverPeer.signal(offer);
        });
    </script>
</body>
</html>
